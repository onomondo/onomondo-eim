#!/usr/bin/env escript

% THIS SCRIPT MUST BE LAUNCHED FROM the ./src folder AFTER building the project with "make" from the main directory

-module(hackney_req_test).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Make sure escript can find all the required dependencies / libraries

-define(BASE_PATH, "../deps/").
-define(PATHS, ["hackney", "certifi", "idna", "metrics", "mimerl", "ssl_verify_fun", "unicode_util_compat", "parse_trans", "jiffy"]).

add_path([]) ->
	ok;
add_path([P|Tail]) ->
	FullP = string:join([?BASE_PATH, P, "/ebin"], ""),
	%io:format("Adding ~p to path~n", [FullP]),
	code:add_path(FullP),
	add_path(Tail).

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% main test code
%%
init() ->
	add_path(?PATHS),
	code:add_path("../ebin"),
	{ok, _} = application:ensure_all_started(hackney).


main(_) ->
	init(),
	%#es9p_client:make_req_json("https://testsmdpplus1.example.com", "initiateAuthentication", #{<<"a">> => <<"b">>}).
	Eui1 = #{svn => "2.1.0",
		 euiccCiPKIdListForVerification => [],
		 euiccCiPKIdListForSigning => []},
	Req = {initiateAuthenticationRequest, #{euiccChallenge => base64:encode("0123456789abcdef"),
						smdpAddress => <<"testsmdpplus1.example.com">>,
						euiccInfo1 => Eui1}},
	es9p_client:request_json(Req, "https://testsmdpplus1.example.com").
